---
layout: post
title: network-http1.1优化
date: 2021-07-28
tags: zyb_note 
---

<h2 align="center">HTTP1.1优化</h2>

主要有三个思路来优化HTTP1.1协议，比如有三种思路来实现。

- 尽量避免发送HTTP请求
- 在需要发送HTTP请求的时候，考虑如何减少请求次数
- 减少服务器的HTTP响应数据大小

下面就针对这三种思路具体看看有哪些优化的方法。



### 一、尽量避免发送请求

缓存技术，客户端会把第一次请求以及其响应的数据保存在本地磁盘中，其中可以将通过key:value的形式去保存缓存的数据。

#### 1.1 强制缓存，协商缓存的关系与区别：

浏览器第一次打开一个网页获取资源后，根据返回的header信息来告诉如何缓存资源。浏览器第一次请求。

![PCB_management](/images/network/requestFirst.png)

![img](https://images2015.cnblogs.com/blog/408483/201605/408483-20160525182843100-1556227104.png)

浏览器发送请求，无缓存的情况下，请求响应之后，根据响应的头部告诉我们如何进行缓存。1.expires 有效期至什么时候。2 cache-control  3.Etag    4.last-modified

![image](https://images2015.cnblogs.com/blog/408483/201605/408483-20160525182943272-204994049.png)

 在后续的请求中，在发送之前，会首先检查本地缓存，是否含有该请求的结果。如果有的话，就先去检查其头部是否命中强制缓存（Expires 、cache-control），若命中直接从缓存中获取资源信息，包括缓存header信息，本次请求就不会与服务器进行通信。如果没有命中的话，就会发送网络请求，但是在发送的时候需要带上其头部有关的字段（Etag/If-none-match  和  Last-modified/If-modified-since）由服务器来判断是否命中协商缓存，如果命中的话，就返回一个 304 not modified，那么客户端直接从缓存中获取数据，如果返回了新的数据，那么就在缓存中更新相关的信息。

#### 强制缓存相关字段

##### Expires策略：

expires是web服务器中响应消息头字段，在响应http请求时告诉浏览器在过期时间前浏览器可以直接从浏览器缓存取数据，而无需再次请求。Expires设置失效时间，精确到时分秒。不过Expires 是HTTP 1.0的东西，现在默认浏览器均默认使用HTTP 1.1，所以它的作用基本忽略。

##### Cache-control策略：

cache-control与Expires的作用一致，都是指明当前资源的有效期，控制浏览器是否直接从浏览器缓存拿到数据还是从服务器端去获取数据。只不过Cache-control的选项更多一些，设置更加精细，如果同时设置的话，其优先级高于Expires。

Http协议头：Cache-control 其value可以为 `private`、 `no-cache` 、`  no-store`、 ` no-transform`、 `must-revalidate` 、`proxy-revalidate` 、`max-age`

各个消息中的指令含义如下：

1. Public指示响应可被任何缓存区缓存。
2. private指示对于单个用户的整个或者部分响应消息，不能被共享缓存处理。这允许服务器仅仅描述用户的部分响应消息，此相应消息对于其他用户的请求无效。
3. no-cache代表不缓存过期的资源，缓存会向服务器进行有效处理确认之后处理资源，do-not-serve-from-cache-without-revalidation
4. no-store表示全面禁止缓存。
5. max-age指示客户机可以接收生存期不大于指定时间（以秒为单位）的响应。

#### 协商缓存的相关字段

Last-modified/If-Modified-since 和 Etag/If-None-Match 这两组搭档是成对出现的，也就说第一次请求中出现了Last-modified，那么接下来的请求中就会带上If-Modified-Since字段，如果第一次请求中带有Etag字段的话，那么接下来的请求中就会带有If-None-Match字段。

这两个字段都需要配合Cache-control来使用，只有在未能命中强制缓存的时候，才能发起带有协商缓存字段的请求。

Last-modified/If-Modified-since

- last-modified：标示这个响应资源的最后修改时间。web服务器在响应请求的时候，告诉服务器的请求最终修改时间。
- If-modified-since：当资源过期了，发现响应头中具有last-modified声明，则再次发起请求的时候带上last-modified的时间，服务器收到请求后发现有if-modified-since则与被请求资源的最后修改时间进行对比（Last-Modified）,若最后修改时间较新（大），说明资源又被改过，则返回最新资源，HTTP 200 OK;若最后修改时间较旧（小），说明资源无新修改，响应HTTP 304 走缓存。

Etag/If-None-Match



